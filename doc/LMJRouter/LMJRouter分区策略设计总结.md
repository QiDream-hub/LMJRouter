# LMJRouter分区策略设计总结

## 一、根本目标

**将多个物理上独立、配置各异的 LMJCore 存储实例，在逻辑上呈现为一个统一的存储系统，同时完全保留每个实例的原有特性。**

---

## 二、核心设计思想

### 1. **指针即地址**
- 每个数据实体（对象/数组）由一个全局唯一的 17 字节指针标识
- 指针中固定位置编码了该实体所属的物理实例编号
- **指针成为数据的绝对地址**，直接包含路由信息

### 2. **透明分区**
- 逻辑层看到的是单一的指针空间
- 物理层根据指针中的实例编号自动路由到对应实例
- 上层无需感知数据在哪个物理实例中

### 3. **配置自描述**
- 系统配置本身也存储在 LMJCore 实例中
- 特殊实例（编号 0）专门存储路由配置
- 形成自包含、自描述的架构

---

## 三、路由机制

### 1. **读取路由**
- 解析指针 → 提取实例编号 → 转发到对应实例 → 返回结果
- 完全透明，上层无感知

### 2. **写入路由**
- **更新现有数据**：必须去数据所在实例（由指针决定）
- **创建新数据**：可选择空闲实例，生成包含新实例编号的指针

### 3. **跨实例引用**
- 允许指针跨实例引用其他数据
- 读取时透明处理
- 写入时**不保证跨实例操作的原子性**，由上层处理一致性

---

## 四、设计特性

### 1. **保留异构性**
- 每个实例可独立配置：内存/磁盘模式、同步策略、加密、指针生成器等
- 支持针对不同数据特性选择不同存储策略

### 2. **并发性提升**
- 不同实例的写入可并行执行
- 突破单实例的"单写者"限制
- 读取完全并发，不受影响

### 3. **故障隔离**
- 单个实例故障仅影响该实例的数据
- 其他实例继续正常服务
- 系统具备优雅降级能力

---

## 五、架构边界

### 上层责任：
- 生成全局唯一的指针
- 处理跨实例操作的一致性
- 根据业务特性选择适当的实例配置

### 路由层责任：
- 按指针中的实例编号透明转发请求
- 管理实例配置和连接状态
- 负载均衡（新数据分配）

### 实例责任：
- 提供完整的 LMJCore 存储能力
- 保持自身配置特性
- 处理分配到的数据读写

---

## 六、设计哲学

### 1. **简单性优先**
- 路由逻辑基于固定位置解析，无复杂算法
- 配置存储复用现有技术栈，不引入新组件
- 错误处理直接明了

### 2. **透明性与可控性平衡**
- 默认完全透明路由
- 支持上层显式控制（指定目标实例）
- 不隐藏重要边界（如跨实例原子性）

### 3. **演进友好**
- 从单实例到多实例平滑过渡
- 支持动态添加/移除实例
- 配置可在线更新

---

## 七、核心价值

1. **逻辑统一**：上层使用单一的编程模型
2. **物理灵活**：底层可按需配置不同存储策略
3. **性能可扩展**：通过增加实例提升并发写入能力
4. **故障隔离**：局部问题不影响全局
5. **技术栈一致**：配置、数据使用同一存储引擎

---

这个设计通过在指针中编码物理位置信息，实现了**逻辑统一与物理分离**的完美平衡，既保持了单实例的简洁性，又获得了多实例的灵活性与扩展性。